-- se evaluara resultados de ventas a la fecha
-- generar informacion estadisticas
-- se generara posteriormente en PDF
-- RESUMEN MENUAL POR VENDEDOR

-> reportes de gestion -> RESUMEN_VENTA_MES
-> registros de ventas deberan ser CON documents BOLETAS y Facturas
-> total MES Y YEAR
-> VARIABLE bind 19%



-- * SE DEBE AGREGAR DATA
-- ? regustros de la tabla RESUMEN_VENTA_MES
MES_ANNO               VARCHAR2(10) -- 02-2024
TIPO_DOCTO             VARCHAR2(3) -- FAC - BOL 
CANT_TOTAL_DOCTO       NUMBER(8) -- suma    
MONTO_NETO_TOTAL       NUMBER(8)    
MONTO_IVA_TOTAL        NUMBER(8)    
MONTO_TOTAL            NUMBER(8)

-- une operacion subconsulta se funcioanna
MERGE INTO RESUMEN_VENTA_MES rvm
-- especificacion de subconsulta
USING (
    SELECT TO_CHAR(FECHA, 'MM_YYYY') AS MES_ANNO,'BOL' AS TIPO_DOCTO,
        COUNT(*) AS CANT_TOTAL_DOCTO,
        SUM(TOTAL / 1.19) AS MONTO_NETO_TOTAL,
        SUM(TOTAL- (TOTAL / 1.19)) AS MONTO_IVA_TOTAL,
        SUM(TOTAL) AS MONTO_TOTAL
    FROM BOLETA
    GROUP BY TO_CHAR(FECHA, 'MM_YYYY')
    
    UNION ALL
    
    SELECT
        TO_CHAR(FECHA, 'MM_YYYY') AS MES_ANNO,
        'FAC' AS TIPO_DOCTO,
        COUNT(*) AS CANT_TOTAL_DOCTO,
        SUM(NETO) AS MONTO_NETO_TOTAL,
        SUM(IVA) AS MONTO_IVA_TOTAL,
        SUM(NETO + IVA) AS MONTO_TOTAL
    FROM FACTURA
    GROUP BY TO_CHAR(FECHA, 'MM_YYYY')
) ventas
-- especifica una condicion
ON (rvm.MES_ANNO = ventas.MES_ANNO AND rvm.TIPO_DOCTO = ventas.TIPO_DOCTO)
-- cuando encuentra la coincidencia
WHEN MATCHED THEN
    UPDATE SET
        rvm.CANT_TOTAL_DOCTO = ventas.CANT_TOTAL_DOCTO,
        rvm.MONTO_NETO_TOTAL = ventas.MONTO_NETO_TOTAL,
        rvm.MONTO_IVA_TOTAL = ventas.MONTO_IVA_TOTAL,
        rvm.MONTO_TOTAL = ventas.MONTO_TOTAL
WHEN NOT MATCHED THEN
    INSERT (MES_ANNO, TIPO_DOCTO, CANT_TOTAL_DOCTO, MONTO_NETO_TOTAL, MONTO_IVA_TOTAL, MONTO_TOTAL)
    VALUES (ventas.MES_ANNO, ventas.TIPO_DOCTO, ventas.CANT_TOTAL_DOCTO, ventas.MONTO_NETO_TOTAL, ventas.MONTO_IVA_TOTAL, ventas.MONTO_TOTAL);







SI ES BOLETA DIVIDE 1.19 SE REGISTRA EN EL NETO






    -- Definir variable BIND para el valor del IVA
VARIABLE iva NUMBER;
BEGIN
    :iva := 0.19; -- IVA del 19%
END;
/

-- Consulta para el reporte de gesti√≥n desde la tabla RESUMEN_VENTA_MES
SELECT 
    TO_CHAR(FECHA, 'MM/YYYY') AS MES_ANIO,
    SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA * (1 - :iva) END) AS TOTAL_NETO,
    CASE
        WHEN SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) < 100000 THEN 'No se paga bono'
        WHEN SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) >= 100000 AND SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) <= 200000 THEN SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) * 0.1
        WHEN SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) >= 200000 AND SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) <= 300000 THEN SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) * 0.15
        WHEN SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) >= 300000 AND SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) <= 400000 THEN SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) * 0.20
        ELSE SUM(CASE WHEN DOCUMENTO IN ('BOLETA', 'FACTURA') THEN TOTAL_VENTA END) * 0.25
    END AS BONO_META
FROM 
    RESUMEN_VENTA_MES
GROUP BY 
    TO_CHAR(FECHA, 'MM/YYYY');


CREATE TABLE RESULTADOS_VENTAS(
    RUTVENDEDOR VARCHAR2(10),
    MES_ANNO VARCHAR2(10),
    TIPO VARCHAR2(3),
    CANT_TOAL_DOC NUMBER(3),
    MONTO_NETO_TOTAL  NUMBER(10),
    MONTO_IVA_TOTAL  NUMBER(10),
    MONTO_TOTAL  NUMBER(10),
    COMISION NUMBER(2,2),
    TOT_COMISION  NUMBER(8,2)  
    BONO_META NUMBER(10),
    TOTAL_PAGO_MES NUMBER(10)
);
